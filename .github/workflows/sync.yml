name: 'Sync All Branches and Releases from Upstream to Fork'

permissions:
  contents: write

on:
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤©è‡ªåŠ¨åŒæ­¥
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      sync_test_mode:
        description: 'Fork Sync Test Mode'
        type: boolean
        default: false

jobs:
  sync_all_branches_from_upstream_to_fork:
    runs-on: ubuntu-latest
    name: Sync all branches from upstream to fork
    if: ${{ github.event.repository.fork }}

    steps:
    - name: Checkout target repo (fork)
      uses: actions/checkout@v3
      with:
        persist-credentials: false  # ç¡®ä¿ä¸ä¼šä½¿ç”¨ç¼“å­˜çš„ GitHub å‡­è¯

    - name: Set up Git configuration
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Add upstream remote (clash-verge-rev)
      run: |
        git remote add upstream https://github.com/clash-verge-rev/clash-verge-rev.git
        git fetch upstream

    - name: List all branches from upstream
      run: |
        # è·å–ä¸Šæ¸¸ä»“åº“çš„æ‰€æœ‰åˆ†æ”¯
        upstream_branches=$(git branch -r | grep 'upstream/' | sed 's/upstream\///')
        echo "Branches to sync: $upstream_branches"

    - name: Sync all branches from upstream to fork
      run: |
        # éå†æ‰€æœ‰ä¸Šæ¸¸åˆ†æ”¯å¹¶åŒæ­¥
        for branch in $upstream_branches; do
          echo "Syncing branch: $branch"
          
          # æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰è¯¥åˆ†æ”¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†æ”¯
          git checkout $branch || git checkout -b $branch
          
          # æ‹‰å–ä¸Šæ¸¸åˆ†æ”¯çš„æ›´æ–°
          git pull upstream $branch
          
          # å°†æ›´æ–°åçš„åˆ†æ”¯æ¨é€åˆ° fork ä»“åº“
          git push origin $branch
        done

  sync_releases_from_upstream_to_fork:
    name: Sync all releases from upstream to fork
    runs-on: ubuntu-latest
    needs: sync_all_branches_from_upstream_to_fork  # ç¡®ä¿ä»£ç åŒæ­¥å®Œæˆåå†åŒæ­¥ releases

    steps:
    - name: Checkout target repo (fork)
      uses: actions/checkout@v3

    - name: Install GitHub CLI & jq
      run: |
        sudo apt update
        sudo apt install -y gh jq

    - name: Authenticate GitHub CLI
      run: echo "${{ secrets.GH_TOKEN }}" | gh auth login --with-token

    - name: Clone upstream repo and prepare workspace
      run: |
        gh repo clone clash-verge-rev/clash-verge-rev upstream-repo
        mkdir -p releases_download

    - name: Sync all upstream releases with pagination
      run: |
        upstream_repo="clash-verge-rev/clash-verge-rev"
        fork_repo="${{ github.repository }}"

        echo "Fetching all upstream releases with pagination..."
        page=1
        all_upstream_releases="[]"
        while :; do
          releases=$(gh api -H "Accept: application/vnd.github+json" "/repos/$upstream_repo/releases?per_page=100&page=$page")
          count=$(echo "$releases" | jq length)
          if [ "$count" -eq 0 ]; then
            break
          fi
          all_upstream_releases=$(jq -s 'add' <(echo "$all_upstream_releases") <(echo "$releases"))
          ((page++))
        done
        echo "$all_upstream_releases" > upstream_releases.json
        echo "Fetched all upstream releases."

        echo "Fetching all fork releases with pagination..."
        page=1
        all_fork_releases="[]"
        while :; do
          releases=$(gh api -H "Accept: application/vnd.github+json" "/repos/$fork_repo/releases?per_page=100&page=$page")
          count=$(echo "$releases" | jq length)
          if [ "$count" -eq 0 ]; then
            break
          fi
          all_fork_releases=$(jq -s 'add' <(echo "$all_fork_releases") <(echo "$releases"))
          ((page++))
        done
        echo "$all_fork_releases" > fork_releases.json
        echo "Fetched all fork releases."

        existing_tags=$(jq -r '.[].tag_name' fork_releases.json | tr '\n' ' ')
        echo "Fork already has tags: $existing_tags"

        echo "Sorting upstream releases by creation date..."
        sorted_releases=$(jq -s 'add | sort_by(.created_at)' upstream_releases.json)

        echo "$sorted_releases" | jq -c '.[] | select(.draft == false)' | while read -r release; do
          tag=$(echo "$release" | jq -r '.tag_name')

          if echo "$existing_tags" | grep -qw "$tag"; then
            echo "âœ” Release $tag already exists in fork, skipping."
            continue
          fi

          title=$(echo "$release" | jq -r '.name')
          body=$(echo "$release" | jq -r '.body // ""')
          prerelease=$(echo "$release" | jq -r '.prerelease')

          download_dir="releases_download/$tag"
          mkdir -p "$download_dir"

          echo "â¬‡ Downloading assets for $tag..."
          gh release download "$tag" -R "$upstream_repo" -D "$download_dir" || echo "âš  No assets for $tag."

          echo "ğŸš€ Creating release $tag in fork..."
          if [ "$prerelease" = "true" ]; then
            gh release create "$tag" $download_dir/* \
              -R "$fork_repo" \
              -t "$title" \
              -n "$body" \
              --prerelease
          else
            gh release create "$tag" $download_dir/* \
              -R "$fork_repo" \
              -t "$title" \
              -n "$body"
          fi

          echo "âœ… Synced release: $tag"

          # åˆ é™¤å½“å‰åŒæ­¥çš„æ–‡ä»¶ï¼Œé‡Šæ”¾ç©ºé—´
          echo "ğŸ§¹ Cleaning up downloaded files for $tag..."
          rm -rf "$download_dir"

          # åˆ é™¤ fork ä¸­çš„ releaseï¼ˆåŒæ­¥ä¸€ä¸ªåˆ é™¤ä¸€ä¸ªï¼‰
          echo "ğŸ—‘ Deleting release $tag from fork..."
          gh release delete "$tag" -R "$fork_repo" --confirm || echo "âš  Failed to delete release $tag from fork."
          
        done
